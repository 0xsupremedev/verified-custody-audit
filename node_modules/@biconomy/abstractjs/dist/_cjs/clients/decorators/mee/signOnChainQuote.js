"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.signOnChainQuote = exports.FUSION_NATIVE_TRANSFER_PREFIX = void 0;
const viem_1 = require("viem");
exports.FUSION_NATIVE_TRANSFER_PREFIX = "0x150b7a02";
const ON_CHAIN_PREFIX = "0x177eee01";
const signOnChainQuote = async (client, params) => {
    const { confirmations = 2, account: account_ = client.account, fusionQuote: { quote, trigger } } = params;
    const { chain, walletClient, address: spender } = account_.deploymentOn(trigger.chainId, true);
    const [{ calls: [triggerCall] }] = await account_.build({
        type: "approve",
        data: {
            spender,
            tokenAddress: trigger.tokenAddress,
            chainId: trigger.chainId,
            amount: trigger.amount
        }
    });
    const dataOrPrefix = triggerCall?.data ?? exports.FUSION_NATIVE_TRANSFER_PREFIX;
    const call = { ...triggerCall, data: (0, viem_1.concatHex)([dataOrPrefix, quote.hash]) };
    const hash = await walletClient.sendTransaction(call);
    await walletClient.waitForTransactionReceipt({ hash, confirmations });
    const signature = (0, viem_1.concatHex)([
        ON_CHAIN_PREFIX,
        (0, viem_1.encodeAbiParameters)([{ type: "bytes32" }, { type: "uint256" }], [hash, BigInt(chain.id)])
    ]);
    return {
        ...quote,
        signature
    };
};
exports.signOnChainQuote = signOnChainQuote;
exports.default = exports.signOnChainQuote;
//# sourceMappingURL=signOnChainQuote.js.map