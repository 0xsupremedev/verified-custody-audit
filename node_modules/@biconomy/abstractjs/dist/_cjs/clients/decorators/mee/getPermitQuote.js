"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getPermitQuote = void 0;
const batchInstructions_1 = require("../../../account/utils/batchInstructions.js");
const resolveInstructions_1 = require("../../../account/utils/resolveInstructions.js");
const composabilityCalls_1 = require("../../../modules/utils/composabilityCalls.js");
const getQuote_1 = require("./getQuote.js");
const getPermitQuote = async (client, parameters) => {
    const { account: account_ = client.account, trigger, cleanUps, instructions, ...rest } = parameters;
    const sender = account_.signer.address;
    const recipient = account_.addressOn(trigger.chainId, true);
    const resolvedInstructions = await (0, resolveInstructions_1.resolveInstructions)(instructions);
    const isComposable = resolvedInstructions.some(({ isComposable }) => isComposable);
    const transferFromAmount = trigger.includeFee
        ? (0, composabilityCalls_1.runtimeERC20AllowanceOf)({
            owner: sender,
            spender: recipient,
            tokenAddress: trigger.tokenAddress,
            constraints: [(0, composabilityCalls_1.greaterThanOrEqualTo)(1n)]
        })
        : trigger.amount;
    const params = {
        type: "transferFrom",
        data: {
            tokenAddress: trigger.tokenAddress,
            chainId: trigger.chainId,
            amount: transferFromAmount,
            recipient,
            sender,
            gasLimit: 50000n
        }
    };
    const triggerTransfer = await (isComposable
        ? account_.buildComposable(params)
        : account_.build(params));
    const batchedInstructions = await (0, batchInstructions_1.batchInstructions)({
        account: account_,
        instructions: [...triggerTransfer, ...resolvedInstructions]
    });
    const quote = await (0, getQuote_1.getQuote)(client, {
        path: "quote-permit",
        eoa: account_.signer.address,
        instructions: batchedInstructions,
        ...(cleanUps ? { cleanUps } : {}),
        ...rest
    });
    const amount = trigger.includeFee
        ? BigInt(trigger.amount)
        : BigInt(trigger.amount) + BigInt(quote.paymentInfo.tokenWeiAmount);
    return {
        quote,
        trigger: {
            tokenAddress: trigger.tokenAddress,
            chainId: trigger.chainId,
            amount
        }
    };
};
exports.getPermitQuote = getPermitQuote;
exports.default = exports.getPermitQuote;
//# sourceMappingURL=getPermitQuote.js.map